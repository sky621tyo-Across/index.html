<!doctype html>
<html lang="ja">\>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar URL Generator（Google / Apple / Outlook 対応）</title>
  <style>
    :root { --max: 860px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; line-height: 1.6; margin: 0; background: #f7f7f8; }
    header { background: #0f172a; color: #fff; padding: 24px 16px; }
    header h1 { margin: 0; font-size: 20px; }
    main { max-width: var(--max); margin: 24px auto; padding: 0 16px; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.06); padding: 20px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 720px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 6px; }
    input[type="text"], input[type="date"], input[type="time"], input[type="url"], textarea { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; font-size: 14px; box-sizing: border-box; }
    textarea { min-height: 96px; resize: vertical; }
    .row { display: flex; gap: 12px; align-items: center; }
    .muted { color: #6b7280; font-size: 12px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    button, .btn { cursor: pointer; border: 0; padding: 10px 14px; border-radius: 10px; background: #111827; color: #fff; font-weight: 600; }
    .btn.secondary { background: #e5e7eb; color: #111827; }
    .output { display: grid; gap: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .help { background: #f1f5f9; border-radius: 12px; padding: 12px; font-size: 13px; }
    footer { max-width: var(--max); margin: 20px auto 60px; padding: 0 16px; color: #6b7280; font-size: 12px; }
    /* 検索候補 */
    .results { position: relative; }
    .results ul { list-style: none; margin: 6px 0 0; padding: 0; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,.08); overflow: hidden; }
    .results li { padding: 10px 12px; cursor: pointer; }
    .results li:hover { background: #f8fafc; }
    .nores { color: #6b7280; font-size: 12px; margin-top: 6px; }
    details { margin-top: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Calendar URL Generator（Google / Apple / Outlook 対応・場所検索つき）</h1>
  </header>
  <main>
    <section class="card">
      <div class="grid grid-2">
        <div class="grid" style="grid-column:1 / -1;">
          <label for="placeSearch">場所検索（無料API）</label>
          <input id="placeSearch" type="text" placeholder="例）渋谷ヒカリエ / 台北101 / 東京国立近代美術館" />
          <div id="placeResults" class="results"></div>
          <div class="muted">候補から選ぶと「会場名」「住所」に自動入力します。精度は地名により差があります。</div>
          <details>
            <summary>高度な設定：Google Placesで補完（APIキー任意）</summary>
            <div class="row" style="margin-top:8px;">
              <input id="gApiKey" type="text" placeholder="Google Places APIキー（リファラー制限推奨）" />
              <button id="loadPlaces" class="btn secondary">有効化</button>
            </div>
            <div class="muted" style="margin-top:6px;">注意：静的サイトではキーが公開されます。必ず“HTTP リファラー制限（自サイトのドメイン）”を設定してください。Googleは課金が必要です。</div>
          </details>
        </div>
        <div>
          <label for="title">タイトル</label>
          <input id="title" type="text" required placeholder="例）写真展『街の断片』" />
        </div>
        <div>
          <label for="venue">会場名</label>
          <input id="venue" type="text" placeholder="例）○○ギャラリー" />
        </div>
        <div>
          <label for="startDate">開始日</label>
          <input id="startDate" type="date" required />
        </div>
        <div>
          <label for="endDate">終了日</label>
          <input id="endDate" type="date" required />
        </div>
        <div class="row">
          <input id="allday" type="checkbox" />
          <label for="allday" style="margin:0;">終日イベント</label>
        </div>
        <div></div>
        <div>
          <label for="startTime">開始時間 <span class="muted">（終日でない場合）</span></label>
          <input id="startTime" type="time" />
        </div>
        <div>
          <label for="endTime">終了時間 <span class="muted">（終日でない場合）</span></label>
          <input id="endTime" type="time" />
        </div>
        <div>
          <label for="address">住所</label>
          <input id="address" type="text" placeholder="例）東京都○○区…" />
        </div>
        <div>
          <label for="url">告知URL</label>
          <input id="url" type="url" placeholder="https://example.com" />
        </div>
        <div class="grid" style="grid-column:1 / -1;">
          <label for="memo">詳細・メモ</label>
          <textarea id="memo" placeholder="営業時間や休館日、備考など"></textarea>
        </div>
      </div>
      <div class="actions" style="margin-top:16px;">
        <button id="genBtn">GoogleカレンダーURL</button>
        <button id="openBtn" class="btn secondary" disabled>Googleで開く</button>
        <button id="copyBtn" class="btn secondary" disabled>URLをコピー</button>
        <button id="icsBtn" class="btn secondary" disabled>Apple/Outlook（.ics保存）</button>
        <button id="olLiveBtn" class="btn secondary" disabled>Outlook.comで開く</button>
        <button id="olM365Btn" class="btn secondary" disabled>Microsoft 365で開く</button>
      </div>
      <div class="output" style="margin-top:16px;">
        <label for="out">Googleカレンダー登録URL</label>
        <input id="out" class="mono" type="text" readonly placeholder="ここにURLが表示されます" />
      </div>
      <p class="help" style="margin-top:16px;">
        ・Google: 時刻ありはUTC（Z）で生成。終日は終了日を+1日で渡します（Googleの仕様）。<br>
        ・Apple/Outlook: <code>.ics</code> を保存して開くと追加できます（iPhoneはSafariで開くか、Filesに保存→カレンダーで開く）。<br>
        ・OutlookのWeb: 公式のディープリンクで予定作成画面を開きます。
      </p>
    </section>
  </main>
  <footer>
    © 2025 Calendar URL Generator Sample
  </footer>

  <script>
    function zpad(n){ return String(n).padStart(2, '0'); }

    function formatAllDayDates(startDateStr, endDateStr){
      const s = new Date(startDateStr + 'T00:00:00');
      const e = new Date(endDateStr + 'T00:00:00');
      const ePlus = new Date(e.getTime() + 24*60*60*1000);
      const ymd = d => d.getFullYear() + zpad(d.getMonth()+1) + zpad(d.getDate());
      return { google: ymd(s) + '/' + ymd(ePlus), ics: { dtstart: ymd(s), dtend: ymd(ePlus) } };
    }

    function formatTimedDates(startDateStr, startTimeStr, endDateStr, endTimeStr){
      const start = new Date(startDateStr + 'T' + startTimeStr);
      const end   = new Date(endDateStr + 'T' + endTimeStr);
      const iso = d => d.toISOString().replace(/[-:]|\.\d{3}/g, '').slice(0,15) + 'Z';
      const isoOutlook = d => d.toISOString().slice(0,19) + 'Z';
      return { google: iso(start) + '/' + iso(end), ics: { dtstart: iso(start), dtend: iso(end) }, outlook: { start: isoOutlook(start), end: isoOutlook(end) } };
    }

    function enc(v){ return encodeURIComponent(v || ''); }

    function buildGoogleUrl(){
      const fields = readFields();
      if(!fields.valid) return '';
      const { title, venue, address, url, memo, allday, startD, endD, startT, endT } = fields;

      let dates = '';
      if(allday){
        dates = formatAllDayDates(startD, endD).google;
      } else {
        if(!startT || !endT) return '';
        dates = formatTimedDates(startD, startT, endD, endT).google;
      }

      const base = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
      const loc = [venue, address].filter(Boolean).join(' ');
      const detailsParts = [];
      if(memo) detailsParts.push(memo);
      if(url)  detailsParts.push('詳細: ' + url);
      const details = detailsParts.join('\n');

      return `${base}&text=${enc(title)}&dates=${enc(dates)}&location=${enc(loc)}&details=${enc(details)}&trp=false`;
    }

    function readFields(){
      const title   = document.getElementById('title').value.trim();
      const venue   = document.getElementById('venue').value.trim();
      const startD  = document.getElementById('startDate').value;
      const endD    = document.getElementById('endDate').value;
      const allday  = document.getElementById('allday').checked;
      const startT  = document.getElementById('startTime').value;
      const endT    = document.getElementById('endTime').value;
      const address = document.getElementById('address').value.trim();
      const url     = document.getElementById('url').value.trim();
      const memo    = document.getElementById('memo').value.trim();

      const valid = !!(title && startD && endD && (allday || (startT && endT)) );
      return { valid, title, venue, startD, endD, allday, startT, endT, address, url, memo };
    }

    function buildICS(){
      const { valid, title, venue, startD, endD, allday, startT, endT, address, url, memo } = readFields();
      if(!valid) return '';

      let dtstart = '', dtend = '';
      if(allday){
        const a = formatAllDayDates(startD, endD).ics;
        dtstart = `DTSTART;VALUE=DATE:${a.dtstart}`;
        dtend   = `DTEND;VALUE=DATE:${a.dtend}`;
      } else {
        const t = formatTimedDates(startD, startT, endD, endT).ics;
        dtstart = `DTSTART:${t.dtstart}`;
        dtend   = `DTEND:${t.dtend}`;
      }

      const uid = 'event-' + Date.now() + '@calendar-gen';
      const now = new Date().toISOString().replace(/[-:]|\.\d{3}/g, '').slice(0,15) + 'Z';
      const loc = [venue, address].filter(Boolean).join(' ');
      const descParts = [];
      if(memo) descParts.push(memo);
      if(url)  descParts.push('詳細: ' + url);
      const desc = descParts.join('\\n');

      const ics = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//calendar-url-gen//JP//',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `DTSTAMP:${now}`,
        `SUMMARY:${title.replace(/\r?\n/g,' ')}`,
        `${dtstart}`,
        `${dtend}`,
        loc ? `LOCATION:${loc.replace(/,/g,'\\,').replace(/;/g,'\\;')}` : '',
        desc ? `DESCRIPTION:${desc.replace(/,/g,'\\,').replace(/;/g,'\\;')}` : '',
        url ? `URL:${url}` : '',
        'END:VEVENT',
        'END:VCALENDAR'
      ].filter(Boolean).join('\r\n');
      return ics;
    }

    function downloadICS(){
      const ics = buildICS();
      if(!ics) return;
      const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'event.ics';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
    }

    function buildOutlookUrl(domain){
      const f = readFields();
      if(!f.valid) return '';
      const { title, venue, address, url, memo, allday, startD, endD, startT, endT } = f;
      const base = `https://${domain}/calendar/deeplink/compose?path=/calendar/action/compose&rru=addevent`;
      const loc = [venue, address].filter(Boolean).join(' ');
      const body = [memo, url ? ('詳細: ' + url) : ''].filter(Boolean).join('\n');

      let qs = `&subject=${enc(title)}&location=${enc(loc)}&body=${enc(body)}`;
      if(allday){
        qs += `&allday=true&startdt=${startD}&enddt=${endD}`; // all-day: YYYY-MM-DD
      } else {
        const t = formatTimedDates(startD, startT, endD, endT).outlook; // YYYY-MM-DDTHH:mm:SSZ
        qs += `&startdt=${enc(t.start)}&enddt=${enc(t.end)}`;
      }
      return base + qs;
    }

    const out = document.getElementById('out');
    const genBtn = document.getElementById('genBtn');
    const openBtn = document.getElementById('openBtn');
    const copyBtn = document.getElementById('copyBtn');
    const icsBtn = document.getElementById('icsBtn');
    const olLiveBtn = document.getElementById('olLiveBtn');
    const olM365Btn = document.getElementById('olM365Btn');

    function update(){
      const u = buildGoogleUrl();
      const valid = !!u;
      out.value = u;
      openBtn.disabled = !valid;
      copyBtn.disabled = !valid;
      icsBtn.disabled = !valid;
      olLiveBtn.disabled = !valid;
      olM365Btn.disabled = !valid;
    }

    genBtn.addEventListener('click', (e)=>{ e.preventDefault(); update(); });
    openBtn.addEventListener('click', ()=>{ const u = out.value; if(u) window.open(u, '_blank'); });
    copyBtn.addEventListener('click', async ()=>{
      const u = out.value; if(!u) return;
      try { await navigator.clipboard.writeText(u); copyBtn.textContent = 'コピーしました'; setTimeout(()=>copyBtn.textContent='URLをコピー', 1600); }
      catch(_) { out.select(); document.execCommand('copy'); }
    });

    icsBtn.addEventListener('click', ()=>{ downloadICS(); });
    olLiveBtn.addEventListener('click', ()=>{ const u = buildOutlookUrl('outlook.live.com'); if(u) window.open(u, '_blank'); });
    olM365Btn.addEventListener('click', ()=>{ const u = buildOutlookUrl('outlook.office.com'); if(u) window.open(u, '_blank'); });

    // ====== 場所検索（デフォルト：OpenStreetMap Nominatim） ======
    const searchInput = document.getElementById('placeSearch');
    const resultsBox = document.getElementById('placeResults');

    const debounce = (fn, d=400)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), d); }; };

    async function queryOSM(q){
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=5&addressdetails=1&accept-language=ja&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if(!res.ok) throw new Error('OSM error');
      return res.json();
    }

    function renderResults(items){
      if(!items || items.length===0){ resultsBox.innerHTML = '<div class="nores">候補が見つかりません</div>'; return; }
      const ul = document.createElement('ul');
      items.forEach(it=>{
        const primary = (it.name || (it.display_name||'').split(',')[0] || '').trim();
        const full = it.display_name || primary;
        const li = document.createElement('li');
        li.innerHTML = `<div><strong>${primary}</strong></div><div class="muted">${full}</div>`;
        li.addEventListener('click', ()=>{
          document.getElementById('venue').value = primary;
          document.getElementById('address').value = full;
          resultsBox.innerHTML = '';
        });
        ul.appendChild(li);
      });
      resultsBox.innerHTML='';
      resultsBox.appendChild(ul);
    }

    searchInput.addEventListener('input', debounce(async (e)=>{
      const q = e.target.value.trim();
      if(q.length < 2){ resultsBox.innerHTML=''; return; }
      try{ const data = await queryOSM(q); renderResults(data); }
      catch(err){ resultsBox.innerHTML = '<div class="nores">検索エラー</div>'; }
    }));

    // ====== 任意：Google Places Autocomplete（APIキー入力で有効化） ======
    const loadBtn = document.getElementById('loadPlaces');
    if(loadBtn){
      loadBtn.addEventListener('click', ()=>{
        const key = document.getElementById('gApiKey').value.trim();
        if(!key){ alert('APIキーを入力してください'); return; }
        const s = document.createElement('script');
        window.initPlaces = ()=>{
          try{
            const ac = new google.maps.places.Autocomplete(
              document.getElementById('placeSearch'),
              { fields: ['name','formatted_address','address_components','geometry'], componentRestrictions: { country: ['jp','tw'] } }
            );
            ac.addListener('place_changed', ()=>{
              const p = ac.getPlace();
              const name = p.name || (p.formatted_address ? p.formatted_address.split(',')[0] : '');
              document.getElementById('venue').value = name || '';
              document.getElementById('address').value = p.formatted_address || name;
              resultsBox.innerHTML = '';
            });
            loadBtn.textContent = '有効化済み';
            loadBtn.disabled = true;
          }catch(e){ alert('Placesの初期化に失敗しました'); }
        };
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places&language=ja&region=JP&callback=initPlaces`;
        document.head.appendChild(s);
      });
    }

    // 入力の度にプレビュー更新
    document.querySelectorAll('input, textarea').forEach(el=>{
      el.addEventListener('input', ()=>{ if(el.id !== 'startTime' && el.id !== 'endTime') update(); });
    });
  </script>
</body>
</html>
